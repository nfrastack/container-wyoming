# SPDX-FileCopyrightText: Â© 2025 Nfrastack <code@nfrastack.com>
#
# SPDX-License-Identifier: MIT

wyoming_bootstrap_filesystem() {
    create_folder \
                    "${DATA_PATH},\
                    ${LOG_PATH}" \
                    root:wyoming 755
}

wyoming_setup_container_mode() {
    if [ -f "/container/state/wyoming/mode" ]; then
        print_debug "[setup_container_mode] Importing MODE environment generated variables"
        source /container/state/wyoming/mode
    else
        mkdir -p /container/state/wyoming
        if [ "${MODE,,}" = "aio" ] || [ "${MODE,,}" = "all" ] ; then
            print_debug "[setup_container_mode] Container Mode: ALL"
            print_debug "[setup_container_mode] Creating MODE environment generated variables"
            echo "ENABLE_OPENWAKEWORD=TRUE" | silent tee -a /container/state/wyoming/mode
            echo "ENABLE_PIPER=TRUE" | silent tee -a /container/state/wyoming/mode
            echo "ENABLE_WHISPER=TRUE" | silent tee -a /container/state/wyoming/mode
        else
            modes=$(echo "${MODE,,}" | tr "," "\n")
            for mode in $modes
            do
                case "${mode,,}" in
                    "openwakeword" )
                        print_debug "[setup_container_mode] Enabling Container Mode for: OPENWAKEWORD"
                        service_start 20-openwakeword
                        echo "ENABLE_OPENWAKEWORD=TRUE" | silent tee -a /container/state/wyoming/mode
                    ;;
                    "piper" )
                        service_start 30-piper
                        print_debug "[setup_container_mode] Enabling Container Mode for: PIPER"
                        echo "ENABLE_PIPER=TRUE" | silent tee -a /container/state/wyoming/mode
                    ;;
                    "whisper" )
                        service_start 40-whisper
                        print_debug "[setup_container_mode] Enabling Container Mode for: WHISPER"
                        echo "ENABLE_WHISPER=TRUE" | silent tee -a /container/state/wyoming/mode
                    ;;
                   "none" )
                        print_debug "[setup_container_mode] Do Nothing"
                        echo "ENABLE_NOTHING=TRUE" | silent tee -a /container/state/wyoming/mode
                    ;;
                    *)
                        print_error "[setup_container_mode] Unknown 'MODE' environment variable - exitting.."
                        exit 1
                    ;;
                esac
            done
        fi
        source /container/state/wyoming/mode
    fi
}